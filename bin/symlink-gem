#!/usr/bin/env ruby
# 
#  Copyright 2009 Stanislav Senotrusov <senotrusov@gmail.com>
# 
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
# 
#      http://www.apache.org/licenses/LICENSE-2.0
# 
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.

require 'rubygems'
require 'fileutils'
require 'rbconfig'

ruby_executable = File.join(Config::CONFIG["bindir"], Config::CONFIG["ruby_install_name"]) + Config::CONFIG["EXEEXT"]
pwd = Dir.pwd
gem_home = Gem.path.last

puts(rake = `rake gemspec`)

if generated = rake.match(/Generated: (.*)/)
  gemspec_file = generated[1]
else
  puts "Can not determine gemspec name from rake output, aborting."
  exit 1
end

spec = Gem::Specification.load(gemspec_file)

FileUtils.symlink File.join(pwd, gemspec_file), "#{gem_home}/specifications/#{spec.name}-#{spec.version}.gemspec", :force => true, :verbose => true

symlink_gem_dir = "#{gem_home}/gems/#{spec.name}-#{spec.version}"

if File.exists?(symlink_gem_dir)
  puts "FileUtils.remove_entry_secure \"#{gem_home}/gems/#{spec.name}-#{spec.version}\""
  FileUtils.remove_entry_secure "#{gem_home}/gems/#{spec.name}-#{spec.version}"
end

FileUtils.symlink pwd, "#{gem_home}/gems/#{spec.name}-#{spec.version}", :force => true, :verbose => true

spec.executables.each do |executable|
  executable_path = File.join(gem_home, "bin", executable)
  puts "Creating #{executable_path}"

  File.open(executable_path, 'wb') do |file|
    file.write <<-END
#!#{ruby_executable}
#
# This file was generated by symlink-gem

require 'rubygems'

version = ">= 0"

if ARGV.first =~ /^_(.*)_$/ and Gem::Version.correct? $1 then
  version = $1
  ARGV.shift
end

gem '#{spec.name}', version
load Gem.bin_path('#{spec.name}', '#{executable}', version)
END
  end
  FileUtils.chmod 0755, executable_path
end

