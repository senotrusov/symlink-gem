#!/usr/bin/env ruby1.8
# 
#  Copyright 2006-2008 Stanislav Senotrusov <senotrusov@gmail.com>
# 
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
# 
#      http://www.apache.org/licenses/LICENSE-2.0
# 
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.


$KCODE = "UTF8"

require 'rubygems'
require 'fileutils'
require 'rbconfig'

ruby_executable = File.join(Config::CONFIG["bindir"], Config::CONFIG["ruby_install_name"]) + Config::CONFIG["EXEEXT"]

unless File.exists? 'gem-sources'
  puts "Creating gem-sources"
  FileUtils.mkdir 'gem-sources'
end

unless File.exists? 'bin'
  puts "Creating bin"
  FileUtils.mkdir 'bin'
end

unless File.exists? 'gems'
  puts "Creating gem"
  FileUtils.mkdir 'gems'
end

unless File.exists? 'specifications'
  puts "Creating specifications"
  FileUtils.mkdir 'specifications'
end

def remove_dummies glob_pattern
  Dir.glob(glob_pattern).each do |file|
    if File.read(file) =~ /^#GEM-HERE/
      puts "Removing #{file}"
      FileUtils.rm(file)
    end
  end
end

remove_dummies "specifications/*.gemspec"
remove_dummies "bin/*"

Dir.glob("gems/*").each do |file|
  if File.symlink?(file)
    puts "Removing #{file}"
    FileUtils.rm(file)
  end
end

Dir.glob('gem-sources/*').each do |gem_path|
  unless File.exists?(specfile = "#{gem_path}/#{File.basename gem_path}.gemspec")
    puts "SKIPPING #{gem_path} -- GEMSPEC NOT FOUND (#{specfile})"   
  else
    spec = Gem::Specification.load(specfile)
    
    raise "email must be given" if !spec.email || spec.email.empty?
     
    prefix = spec.email.gsub(/@.*/, '')
    
    puts "Found #{prefix}-#{spec.name}-#{spec.version} in #{gem_path}"
    
    spec.name = "#{prefix}-#{spec.name}"
    
    puts "  Creating gemspec..."

    File.open("specifications/#{spec.name}-#{spec.version}.gemspec", 'wb') do |file|
      file.puts "#GEM-HERE"
      file.puts spec.to_ruby
    end
  
  
    puts "  Creating symlink..."
    
    FileUtils.symlink("../#{gem_path}", "gems/#{spec.name}-#{spec.version}", :force => true)
  
    spec.executables.each do |executable|
      executable_path = "bin/#{executable}"
      puts "  Creating #{executable_path}"

      File.open(executable_path, 'wb') do |file|
        file.write <<-END
#!#{ruby_executable}
#GEM-HERE
require 'rubygems'
Gem.clear_paths
Gem.path.unshift('#{Dir.pwd}')
gem '#{spec.name}'
load '#{executable}'
END
      end
      FileUtils.chmod 0755, executable_path
    end
  end
end

